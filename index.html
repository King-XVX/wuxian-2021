<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>无限工作室 | INFINITY STUDIO</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        primary: '#0ef',
        secondary: '#f0a',
        dark: '#050810',
        light: '#f8fafc'
      },
      fontFamily: {
        cyber: ['Orbitron', 'sans-serif']
      }
    }
  }
}
</script>
<style type="text/tailwindcss">
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&display=swap');
@layer utilities {
  .scroll-smooth { scroll-behavior: smooth; }
  .glass { background: rgba(5,8,16,0.85); backdrop-filter: blur(16px); }
  .img-scale { transition: transform 0.4s ease; }
  .img-scale:hover { transform: scale(1.08); }
  .fade-in { animation: fadeIn 0.5s ease forwards; }
  .slide-up { animation: slideUp 0.5s ease forwards; }

  .scan-line {
    position: relative;
    overflow: hidden;
  }
  .scan-line::after {
    content: '';
    position: absolute;
    top: -100%;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, transparent 0%, rgba(0,238,255,0.08) 50%, transparent 100%);
    animation: scan 5s linear infinite;
  }

  .cyber-error-border {
    position: relative;
    z-index: 1;
  }
  .cyber-error-border::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    border: 2px solid rgba(0,238,255,0.2);
    box-shadow: 0 0 25px rgba(0,238,255,0.15);
    pointer-events: none;
    z-index: 9998;
    animation: borderGlitch 3s infinite alternate ease-in-out;
  }
  @keyframes borderGlitch {
    0% { border-color: rgba(0,238,255,0.2); box-shadow: 0 0 25px rgba(0,238,255,0.15); }
    50% { border-color: rgba(255,0,170,0.25); box-shadow: 0 0 35px rgba(255,0,170,0.2); }
    100% { border-color: rgba(0,238,255,0.2); box-shadow: 0 0 25px rgba(0,238,255,0.15); }
  }

  .neon {
    color: #00cccc;
    font-weight: 700;
    opacity: 0.9;
    animation: neon 3s infinite alternate ease-in-out;
  }
  @keyframes neon {
    0%  { text-shadow: 0 0 8px rgba(0,238,255,0.4), 0 0 16px rgba(0,238,255,0.25); opacity: 0.85; }
    100%{ text-shadow: 0 0 12px rgba(0,238,255,0.6), 0 0 24px rgba(0,238,255,0.35); opacity: 0.95; }
  }

  .glitch {
    position: relative;
  }
  .glitch::before {
    content: attr(data-text);
    position: absolute;
    left: 0; top: 0;
    width: 100%; height: 100%;
    color: #f0a;
    opacity: 0.4;
    animation: glitch 2.8s infinite alternate-reverse;
  }
  @keyframes glitch {
    0%  { transform: translate(0, 0); }
    15% { transform: translate(1px, 1px); }
    35% { transform: translate(-1px, -1px); }
    50% { transform: translate(0, 0); }
    65% { transform: translate(1px, -1px); }
    85% { transform: translate(-1px, 1px); }
    100%{ transform: translate(0, 0); }
  }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity:0; transform: translateY(30px); } to { opacity:1; transform: translateY(0); } }
  @keyframes scan {
    0% { top: -100%; }
    100% { top: 100%; }
  }
  .carousel-item { display: none; }
  .carousel-item.active { display: block; animation: fadeIn 0.8s ease; }

  .cyber-border {
    border: 1px solid rgba(0,238,255,0.3);
    box-shadow: 0 0 12px rgba(0,238,255,0.15);
  }
  .cyber-card:hover {
    box-shadow: 0 0 20px rgba(0,238,255,0.25);
    transform: translateY(-5px);
    transition: all 0.3s ease;
  }
}
</style>
</head>
<body class="bg-dark text-light antialiased cyber-error-border">
<div id="app" class="min-h-screen flex flex-col">

<!-- 导航 -->
<nav class="fixed w-full z-50 glass border-b border-primary/40 transition-all duration-300">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <a href="#home" class="text-xl font-bold text-white neon font-cyber">INFINITY 无限</a>
    <div class="hidden md:flex gap-5 items-center">
      <a href="#home" class="hover:text-primary transition-colors">首页</a>
      <a href="#portfolio" class="hover:text-primary transition-colors">作品集</a>
      <a href="#install" class="hover:text-primary transition-colors">下载作品</a>
      <a href="#team" class="hover:text-primary transition-colors">团队</a>
      <a href="#forum" class="hover:text-primary transition-colors">论坛</a>
      <button id="themeBtn" class="px-3 py-1 rounded bg-gray-900 text-sm hover:brightness-125 transition"></button>
      <button id="adminBtn" class="px-3 py-1 rounded bg-secondary text-white text-sm hover:brightness-125 transition hidden">管理</button>
      <button id="loginToggle" class="px-4 py-2 rounded bg-primary text-dark font-medium hover:brightness-110 transition">登录</button>
    </div>
    <button class="md:hidden text-xl" id="menuBtn"><i class="fa fa-bars"></i></button>
  </div>
</nav>

<!-- 移动端菜单 -->
<div id="mobileMenu" class="fixed top-16 left-0 right-0 glass hidden border-b border-primary/30 z-40">
  <div class="container px-4 py-3 flex flex-col gap-3">
    <a href="#home" class="py-2 hover:text-primary">首页</a>
    <a href="#portfolio" class="py-2 hover:text-primary">作品集</a>
    <a href="#install" class="py-2 hover:text-primary">下载作品</a>
    <a href="#team" class="py-2 hover:text-primary">团队</a>
    <a href="#forum" class="py-2 hover:text-primary">论坛</a>
    <button id="mobileTheme" class="py-2 bg-gray-900 rounded text-sm"></button>
    <button id="mobileAdmin" class="py-2 bg-secondary text-white rounded text-sm hidden">管理</button>
    <button id="mobileLogin" class="py-2 bg-primary text-dark rounded">登录</button>
  </div>
</div>

<main class="flex-1 pt-16">
<!-- 首页轮播 -->
<section id="home" class="relative min-h-[90vh] flex items-center justify-center overflow-hidden scan-line">
  <div class="absolute inset-0 bg-gradient-to-b from-dark via-dark/90 to-dark z-0"></div>
  <div class="absolute inset-0 bg-[url('https://i.ibb.co/r2kB5zgP/wx.png')] opacity-10 bg-cover bg-center z-0"></div>
  <div class="carousel relative z-10 container px-4 text-center max-w-4xl">
    <div class="carousel-item active fade-in">
      <h1 class="text-4xl md:text-7xl font-bold text-white neon slide-up glitch" data-text="无限创意设计">无限创意设计</h1>
      <p class="mt-6 text-gray-300 text-lg slide-up delay-100">专注视觉小说,人物设定,数字工艺 | 赛博朋克创作工作室</p>
    </div>
    <div class="carousel-item fade-in">
      <h1 class="text-4xl md:text-7xl font-bold text-white neon slide-up glitch" data-text="创意交流社区">创意交流社区</h1>
      <p class="mt-6 text-gray-300 text-lg slide-up delay-100">分享灵感，共同成长 | 未来科技美学</p>
    </div>
    <div class="carousel-item fade-in">
      <h1 class="text-4xl md:text-7xl font-bold text-white neon slide-up glitch" data-text="即刻加入我们">即刻加入我们</h1>
      <p class="mt-6 text-gray-300 text-lg slide-up delay-100">无限可能，由你创造</p>
    </div>
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-3 z-10">
      <button class="carousel-dot w-3 h-3 rounded-full bg-primary"></button>
      <button class="carousel-dot w-3 h-3 rounded-full bg-primary/30"></button>
      <button class="carousel-dot w-3 h-3 rounded-full bg-primary/30"></button>
    </div>
    <div class="mt-8 flex flex-wrap justify-center gap-10 slide-up delay-200">
      <a href="#portfolio" class="px-8 py-3 bg-primary text-dark rounded hover:brightness-110 transition uppercase tracking-wider">浏览作品</a>
      <a href="#forum" class="px-6 py-3 border border-primary text-primary rounded hover:bg-primary/10 transition uppercase tracking-wider">加入讨论</a>
    </div>
  </div>
</section>

<!-- 作品安装包中心 -->
<section id="install" class="py-20 bg-dark fade-in">
  <div class="container mx-auto px-4 max-w-5xl">
    <h2 class="text-4xl font-bold text-center mb-3 neon font-cyber glitch" data-text="作品安装包中心">作品安装包中心</h2>
    <p class="text-center text-gray-400 mb-12 text-lg">上传 / 下载项目源文件、安装包、工程文件</p>
    <p class="text-center text-gray-400 mb-6 text-sm">（已登录用户均可上传，所有人均可下载）</p>

    <div id="uploadArea" class="hidden mb-10 p-6 rounded-xl cyber-border bg-black/30">
      <h3 class="text-xl font-bold mb-4 text-primary"><i class="fa fa-cloud-upload mr-2"></i>上传安装包</h3>
      <input id="packageName" placeholder="安装包名称" class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-3 mb-3" maxlength="50">
      <input id="packageDesc" placeholder="简介说明" class="w-full bg-gray-900 border border-gray-700 rounded px-4 py-3 mb-3" maxlength="200">
      <div class="mb-3">
        <input type="file" id="packageFile" class="w-full text-gray-300 file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:bg-primary file:text-dark hover:file:brightness-110">
        <p class="text-gray-400 text-xs mt-1">请选择要上传的文件（最大10MB）</p>
      </div>
      <button id="uploadPackage" class="w-full bg-primary text-dark py-3 rounded hover:brightness-110 transition uppercase tracking-wider">上传安装包</button>
    </div>

    <div id="packageGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="text-center py-10 text-gray-500">
        <i class="fa fa-spinner fa-spin text-3xl mb-3"></i>
        <p>正在从云端加载安装包数据...</p>
      </div>
    </div>
  </div>
</section>

<!-- 作品集 -->
<section id="portfolio" class="py-16 bg-black/30 fade-in">
  <div class="container mx-auto px-4">
    <h2 class="text-3xl font-bold text-center mb-3 neon">精选作品集</h2>
    <p class="text-center text-gray-400 mb-8">点击可预览大图 & 单独下载</p>
    <div class="flex flex-col md:flex-row gap-3 justify-center mb-8">
      <input id="searchWork" placeholder="搜索作品..." class="px-4 py-2 rounded bg-gray-900 border border-gray-700 max-w-md w-full">
      <div class="flex gap-2 flex-wrap justify-center">
        <button data-cate="all" class="cate-btn px-3 py-2 rounded bg-primary text-dark active-cate">全部</button>
        <button data-cate="创意" class="cate-btn px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition">创意</button>
        <button data-cate="文集" class="cate-btn px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition">文集</button>
        <button data-cate="网页" class="cate-btn px-3 py-2 rounded bg-gray-800 hover:bg-gray-700 transition">网页</button>
      </div>
    </div>
    <div id="portfolioGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="text-center py-10 text-gray-500">
        <i class="fa fa-spinner fa-spin text-3xl mb-3"></i>
        <p>正在从云端加载作品数据...</p>
      </div>
    </div>

    <div class="container mx-auto px-4 mt-12 text-center">
      <a class="text-2xl font-bold text-center mb-3 neon hover:text-primary transition-colors inline-block mx-4" href="https://space.bilibili.com/3461563153385678?spm_id_from=333.788.0.0">KING肘子的B站首页</a>
      <a class="text-2xl font-bold text-center mb-3 neon hover:text-primary transition-colors inline-block mx-4" href="https://space.bilibili.com/519116436/dynamic?spm_id_from=333.1387.0.0">群主肘子的B站首页</a>
    </div>
  </div>
</section>

<!-- 团队 -->
<section id="team" class="py-16 bg-dark fade-in">
  <div class="container px-4">
    <h2 class="text-3xl font-bold text-center mb-12 neon">专业团队</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="p-6 cyber-border rounded-lg text-center bg-black/10 slide-up cyber-card">
        <img src="https://i.ibb.co/7db3SJzy/kl.jpg" class="w-28 h-28 rounded-full mx-auto object-cover border-2 border-primary" alt="鴋子">
        <h3 class="mt-4 font-bold text-lg">鴋子</h3>
        <p class="text-primary text-sm">创意提供</p>
      </div>
      <div class="p-6 cyber-border rounded-lg text-center bg-black/10 slide-up delay-100 cyber-card">
        <img src="https://i.ibb.co/ccrj1YXL/hs.jpg" class="w-28 h-28 rounded-full mx-auto object-cover border-2 border-primary" alt="霍斯">
        <h3 class="mt-4 font-bold text-lg">霍斯</h3>
        <p class="text-primary text-sm">文集综合</p>
      </div>
      <div class="p-6 cyber-border rounded-lg text-center bg-black/10 slide-up delay-200 cyber-card">
        <img src="https://i.ibb.co/C371q84q/kg.jpg" class="w-28 h-28 rounded-full mx-auto object-cover border-2 border-primary" alt="King_-G">
        <h3 class="mt-4 font-bold text-lg">King_-G</h3>
        <p class="text-primary text-sm">网页开发</p>
      </div>
      <div class="p-6 cyber-border rounded-lg text-center bg-black/10 slide-up delay-300 cyber-card">
        <img src="https://i.ibb.co/WW5W6qgB/lx.png" class="w-28 h-28 rounded-full mx-auto object-cover border-2 border-primary" alt="洛小">
        <h3 class="mt-4 font-bold text-lg">洛小</h3>
        <p class="text-primary text-sm">审核</p>
      </div>
    </div>
  </div>
</section>

<!-- 论坛 -->
<section id="forum" class="py-16 bg-black/30 fade-in">
  <div class="container px-4 max-w-5xl">
    <h2 class="text-3xl font-bold text-center mb-8 neon">创意论坛</h2>
    <div class="grid md:grid-cols-3 gap-8">
      <div class="md:col-span-1">
        <div class="cyber-border rounded-lg p-5 bg-black/20 sticky top-24">
          <h3 class="font-bold mb-4 text-primary">发布话题</h3>
          <div id="postArea" class="hidden">
            <input id="postTitle" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-3" placeholder="标题" maxlength="100">
            <textarea id="postContent" rows="4" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-3" placeholder="内容" maxlength="1000"></textarea>
            
            <div class="mb-3">
              <input type="file" id="postImage" accept="image/*" class="w-full text-gray-300 file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:bg-primary file:text-dark hover:file:brightness-110">
              <p class="text-gray-400 text-xs mt-1">可选：上传图片（支持JPG、PNG等格式，最大5MB）</p>
              <div id="imagePreview" class="mt-2 hidden">
                <img id="previewImg" class="max-h-40 rounded border border-gray-700">
              </div>
            </div>
            
            <div class="flex gap-2">
              <button id="sendPost" class="flex-1 bg-primary text-dark py-2 rounded hover:brightness-110 transition">发布</button>
              <button id="clearPost" class="px-4 bg-gray-800 text-gray-300 py-2 rounded hover:bg-gray-700 transition">清空</button>
            </div>
            <div class="text-xs text-gray-500 mt-2 text-right">
              <span id="charCount">0/1000</span>
            </div>
          </div>
          <div id="needLogin" class="text-center text-gray-400 py-4">
            <p class="mb-2">请先登录以发布话题</p>
            <button onclick="showLogin()" class="px-4 py-2 bg-primary text-dark rounded hover:brightness-110 transition">立即登录</button>
          </div>
        </div>
      </div>
      <div class="md:col-span-2">
        <div class="cyber-border rounded-lg p-5 bg-black/20">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-primary">最新帖子</h3>
            <div class="text-sm text-gray-400" id="postCount">加载中...</div>
          </div>
          <div id="postList" class="space-y-4">
            <div class="text-center py-8 text-gray-500">
              <i class="fa fa-spinner fa-spin text-3xl mb-3"></i>
              <p>正在从云端加载帖子数据...</p>
            </div>
          </div>
          <div id="noPosts" class="text-center text-gray-400 py-8 hidden">
            <i class="fa fa-comments-o text-4xl mb-3"></i>
            <p>暂无帖子，成为第一个发布话题的人吧！</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 后台管理 -->
<section id="adminPanel" class="py-16 hidden">
  <div class="container px-4 max-w-5xl">
    <h2 class="text-3xl font-bold text-center mb-8 neon">后台管理</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <div class="cyber-border rounded-lg p-5 bg-black/20">
        <h3 class="font-bold mb-4 text-primary">作品管理</h3>
        <input id="workTitle" placeholder="标题" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-2" maxlength="50">
        <select id="workCate" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-2">
          <option value="创意">创意</option>
          <option value="文集">文集</option>
          <option value="网页">网页</option>
        </select>
        <input id="workImgUrl" placeholder="作品图片的网络直链 (URL)" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-2">
        <button id="addWork" class="w-full bg-primary text-dark py-2 rounded hover:brightness-110 transition">添加作品</button>
        <div class="mt-4 max-h-60 overflow-y-auto" id="adminWorkList">
          <div class="text-center py-4 text-gray-500">加载中...</div>
        </div>
      </div>
      <div class="cyber-border rounded-lg p-5 bg-black/20">
        <h3 class="font-bold mb-4 text-primary">用户 & 安装包管理</h3>
        <div class="max-h-60 overflow-y-auto mb-4" id="adminUserList">
          <div class="text-center py-4 text-gray-500">加载中...</div>
        </div>
        <div class="max-h-60 overflow-y-auto" id="adminPackageList">
          <div class="text-center py-4 text-gray-500">加载中...</div>
        </div>
      </div>
    </div>
  </div>
</section>
</main>

<!-- 作品大图预览 -->
<div id="workModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/90" id="closeWorkModal"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-3xl p-5 bg-dark cyber-border rounded-lg fade-in">
    <img id="workModalImg" class="w-full max-h-[70vh] object-contain rounded" alt="作品预览">
    <h3 id="workModalTitle" class="mt-4 text-xl font-bold text-primary"></h3>
    <p id="workModalCate" class="text-gray-400 text-sm"></p>
    <div class="mt-4 flex gap-3">
      <button id="downloadSingle" class="px-4 py-2 bg-primary text-dark rounded hover:brightness-110 transition">下载此作品</button>
      <button class="px-4 py-2 bg-gray-800 rounded hover:brightness-110 transition" id="closeWorkBtn">关闭</button>
    </div>
    <button class="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center" id="closeWorkIcon">✕</button>
  </div>
</div>

<!-- 登录/注册弹窗 -->
<div id="loginModal" class="fixed inset-0 z-[9999] hidden">
  <div class="absolute inset-0 bg-black/80" id="closeLogin"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6 bg-dark cyber-border rounded-lg fade-in">
    <h3 class="text-xl font-bold text-center mb-6 text-primary">登录 / 注册</h3>
    <input id="username" placeholder="用户名" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-3" maxlength="20">
    <input id="email" type="email" placeholder="邮箱" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-3">
    <input id="pwd" type="password" placeholder="密码" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-4">
    <button id="loginBtn" class="w-full bg-primary text-dark py-2 rounded hover:brightness-110 transition mb-2">登录</button>
    <button id="regBtn" class="w-full border border-primary text-primary py-2 rounded hover:bg-primary/10 transition">注册</button>
    <p id="tip" class="text-center text-sm text-green-400 mt-3 hidden"></p>
  </div>
</div>

<!-- 编辑帖子弹窗 -->
<div id="editModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/80" id="closeEdit"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6 bg-dark cyber-border rounded-lg fade-in">
    <h3 class="text-xl font-bold text-center mb-6 text-primary">编辑帖子</h3>
    <input id="editTitle" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-3" placeholder="标题" maxlength="100">
    <textarea id="editContent" rows="5" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-4" placeholder="内容" maxlength="1000"></textarea>
    
    <div class="mb-3">
      <input type="file" id="editPostImage" accept="image/*" class="w-full text-gray-300 file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:bg-primary file:text-dark hover:file:brightness-110">
      <p class="text-gray-400 text-xs mt-1">更新图片（留空则保持原图）</p>
      <div id="editImagePreview" class="mt-2"></div>
    </div>
    
    <div class="flex gap-3">
      <button id="saveEdit" class="flex-1 bg-primary text-dark py-2 rounded hover:brightness-110 transition">保存</button>
      <button id="cancelEdit" class="px-4 bg-gray-800 text-gray-300 py-2 rounded hover:bg-gray-700 transition">取消</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // JSONBin 配置 - 完全保留原配置
  const BIN_ID = '69a461a3ae596e708f556266'; // JSONBin 的存储ID
  const MASTER_KEY = '$2a$10$GX7PPwYGg3HrAvsi9Yh5B.r5eayE1uZm3GSk5JWc1T63wLyNF8JvC'; // 主密钥
  const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`; // 使用v3 API端点
  const JSONBIN_HEADERS = {
    'Content-Type': 'application/json',
    'X-Master-Key': MASTER_KEY,
    'X-Bin-Versioning': false
  };

  // 默认数据（包含用户名系统）
  const DEFAULT_DATA = {
    theme: 'dark',
    user: null,
    users: [
      {email: 'admin@qq.com', username: '管理员', pwd: 'admin123', role: 'admin'}
    ],
    posts: [],
    works: [
      { id: 1, title: "创意提供肘子", cate: "创意", img: "https://i.ibb.co/7db3SJzy/kl.jpg", size: "cytg" },
      { id: 2, title: "文集综合肘子", cate: "文集", img: "https://i.ibb.co/ccrj1YXL/hs.jpg", size: "wjzh" },
      { id: 3, title: "网页开发肘子", cate: "网页", img: "https://i.ibb.co/C371q84q/kg.jpg", size: "wykf" }
    ],
    packages: [
      { id: 1, name: "默认存在测试文件", desc: "看见证明功能正常", uploader: "KING肘子", uploaderUsername: "KING肘子", time: "2026", file: "#", downloads: 114514 }
    ]
  };

  // 应用状态
  let D = {
    theme: localStorage.getItem('theme') || 'dark',
    user: JSON.parse(localStorage.getItem('user')) || null,
    users: [],
    posts: [],
    works: [],
    packages: []
  };

  // 从JSONBin加载数据（增强版）
  async function loadDataFromJSONBin() {
    try {
      showTip('正在从云端加载数据...');
      
      // 添加超时控制
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const response = await fetch(`${JSONBIN_URL}/latest`, {
        headers: {
          'X-Master-Key': MASTER_KEY,
          'X-Bin-Meta': false
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        if (response.status === 404) {
          // Bin不存在，创建新的
          await createNewBin();
          return;
        } else if (response.status === 403 || response.status === 401) {
          // 权限错误
          showTip('云端权限错误，使用本地数据');
          loadFromLocalStorage();
          return;
        }
        throw new Error(`HTTP ${response.status}`);
      }
      
      const binData = await response.json();
      
      // 智能合并数据：保留本地用户状态和主题设置
      D.users = binData.users || DEFAULT_DATA.users;
      D.posts = binData.posts || DEFAULT_DATA.posts;
      D.works = binData.works || DEFAULT_DATA.works;
      D.packages = binData.packages || DEFAULT_DATA.packages;
      
      // 检查当前登录用户是否仍存在于用户列表中
      if (D.user) {
        const userExists = D.users.some(u => u.email === D.user.email);
        if (!userExists) {
          D.user = null;
          localStorage.removeItem('user');
          showTip('用户数据已更新，请重新登录');
        }
      }
      
      // 保存到本地缓存
      saveToLocalStorage();
      updateUI();
      showTip('云端数据加载完成！');
      
    } catch (error) {
      console.error('加载数据失败:', error);
      if (error.name === 'AbortError') {
        showTip('网络超时，使用本地缓存数据');
      } else {
        showTip('加载云端数据失败，使用本地缓存');
      }
      
      // 使用本地存储作为后备
      loadFromLocalStorage();
      updateUI();
    }
  }

  // 加载本地数据
  function loadFromLocalStorage() {
    D.users = JSON.parse(localStorage.getItem('users')) || DEFAULT_DATA.users;
    D.posts = JSON.parse(localStorage.getItem('posts')) || DEFAULT_DATA.posts;
    D.works = JSON.parse(localStorage.getItem('works')) || DEFAULT_DATA.works;
    D.packages = JSON.parse(localStorage.getItem('packages')) || DEFAULT_DATA.packages;
  }

  // 保存到本地
  function saveToLocalStorage() {
    localStorage.setItem('users', JSON.stringify(D.users));
    localStorage.setItem('posts', JSON.stringify(D.posts));
    localStorage.setItem('works', JSON.stringify(D.works));
    localStorage.setItem('packages', JSON.stringify(D.packages));
  }

  // 创建新的JSONBin
  async function createNewBin() {
    try {
      const dataToSave = {
        users: DEFAULT_DATA.users,
        posts: DEFAULT_DATA.posts,
        works: DEFAULT_DATA.works,
        packages: DEFAULT_DATA.packages
      };
      
      const response = await fetch(JSONBIN_URL, {
        method: 'PUT',
        headers: JSONBIN_HEADERS,
        body: JSON.stringify(dataToSave)
      });
      
      if (response.ok) {
        D.users = DEFAULT_DATA.users;
        D.posts = DEFAULT_DATA.posts;
        D.works = DEFAULT_DATA.works;
        D.packages = DEFAULT_DATA.packages;
        saveToLocalStorage();
        updateUI();
        showTip('已创建新的云端数据存储');
      } else {
        throw new Error('创建失败');
      }
    } catch (error) {
      console.error('创建Bin失败:', error);
      showTip('使用默认本地数据');
      loadFromLocalStorage();
      updateUI();
    }
  }

  // 保存数据到JSONBin（增强版）
  async function saveDataToJSONBin() {
    let retryCount = 0;
    const maxRetries = 2;
    
    while (retryCount <= maxRetries) {
      try {
        const dataToSave = {
          users: D.users,
          posts: D.posts,
          works: D.works,
          packages: D.packages
        };
        
        const response = await fetch(JSONBIN_URL, {
          method: 'PUT',
          headers: JSONBIN_HEADERS,
          body: JSON.stringify(dataToSave)
        });
        
        if (!response.ok) {
          if (response.status === 429 && retryCount < maxRetries) {
            // 速率限制，等待后重试
            retryCount++;
            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
            continue;
          }
          throw new Error(`保存失败: HTTP ${response.status}`);
        }
        
        // 同时保存到本地作为缓存
        saveToLocalStorage();
        return true;
        
      } catch (error) {
        console.error('保存数据失败:', error);
        retryCount++;
        
        if (retryCount > maxRetries) {
          // 最终失败，保存到本地
          saveToLocalStorage();
          showTip('云端保存失败，数据已保存到本地');
          return false;
        }
      }
    }
  }

  // 初始化主题
  function initTheme() {
    if (D.theme === 'light') {
      document.documentElement.classList.remove('dark');
      document.getElementById('themeBtn').textContent = '暗色';
      document.getElementById('mobileTheme').textContent = '暗色';
    } else {
      document.documentElement.classList.add('dark');
      document.getElementById('themeBtn').textContent = '亮色';
      document.getElementById('mobileTheme').textContent = '亮色';
    }
  }

  // 更新UI
  async function updateUI() {
    if (D.user) {
      const displayName = D.user.username || D.user.email;
      document.getElementById('loginToggle').innerHTML = `<i class="fa fa-user mr-2"></i>${displayName}`;
      document.getElementById('mobileLogin').innerHTML = `<i class="fa fa-user mr-2"></i>${displayName}`;
      document.getElementById('postArea').classList.remove('hidden');
      document.getElementById('needLogin').classList.add('hidden');
      document.getElementById('uploadArea').classList.remove('hidden');
      if (D.user.role === 'admin') {
        document.getElementById('adminBtn').classList.remove('hidden');
        document.getElementById('mobileAdmin').classList.remove('hidden');
      }
    } else {
      document.getElementById('loginToggle').textContent = '登录';
      document.getElementById('mobileLogin').textContent = '登录';
      document.getElementById('postArea').classList.add('hidden');
      document.getElementById('needLogin').classList.remove('hidden');
      document.getElementById('uploadArea').classList.add('hidden');
      document.getElementById('adminBtn').classList.add('hidden');
      document.getElementById('mobileAdmin').classList.add('hidden');
    }
    await loadPosts();
    await loadWorks();
    await loadPackages();
  }

  // 载入帖子
  async function loadPosts() {
    const list = document.getElementById('postList');
    const count = document.getElementById('postCount');
    const noPosts = document.getElementById('noPosts');
    
    list.innerHTML = '';
    count.textContent = D.posts.length + '个帖子';
    
    if (D.posts.length === 0) {
      noPosts.classList.remove('hidden');
      list.innerHTML = '';
      return;
    }
    
    noPosts.classList.add('hidden');
    D.posts.slice().reverse().forEach((p, i) => {
      const userObj = D.users.find(u => u.email === p.userEmail);
      const displayName = userObj ? (userObj.username || userObj.email) : '未知用户';
      const canDelete = D.user && (D.user.role === 'admin' || D.user.email === p.userEmail);
      const canEdit = D.user && D.user.email === p.userEmail;
      
      const html = `
        <div class="p-4 cyber-border rounded bg-black/20 fade-in" data-post-id="${p.id}">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-bold text-lg">${escapeHtml(p.title)}</h4>
              <p class="text-sm text-gray-400">作者: ${escapeHtml(displayName)} • ${p.time}</p>
            </div>
            ${canDelete ? `<button class="text-red-400 hover:text-red-300" onclick="deletePost(${p.id})"><i class="fa fa-trash"></i></button>` : ''}
          </div>
          <p class="mt-2 whitespace-pre-wrap">${escapeHtml(p.content)}</p>
          
          ${p.image ? `<div class="mt-3"><img src="${p.image}" class="max-w-full max-h-80 rounded border border-gray-700" alt="帖子图片" loading="lazy"></div>` : ''}
          
          <div class="mt-3 text-sm text-gray-500">
            <button onclick="toggleComment(${p.id})" class="hover:text-primary"><i class="fa fa-comment"></i> ${p.comments?.length || 0} 条评论</button>
            ${canEdit ? `<button class="ml-3 hover:text-primary" onclick="editPost(${p.id})"><i class="fa fa-edit"></i> 编辑</button>` : ''}
          </div>
          <div id="commentArea-${p.id}" class="mt-3 hidden">
            <div class="mb-3">
              <input id="commentInput-${p.id}" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 mb-2" placeholder="写下你的评论" maxlength="500">
              <div class="flex justify-between items-center">
                <span class="text-xs text-gray-400" id="commentCount-${p.id}">0/500</span>
                <button onclick="addComment(${p.id})" class="px-4 py-1 bg-primary text-dark rounded text-sm hover:brightness-110 transition">发送评论</button>
              </div>
            </div>
            <div id="comments-${p.id}">
              ${p.comments ? p.comments.map(c => {
                const commentUser = D.users.find(u => u.email === c.userEmail);
                const commentName = commentUser ? (commentUser.username || commentUser.email) : '未知用户';
                const canDeleteComment = D.user && (D.user.role === 'admin' || D.user.email === c.userEmail);
                return `
                <div class="p-2 bg-gray-900/50 rounded mb-1 flex justify-between">
                  <div>
                    <span class="font-medium">${escapeHtml(commentName)}</span>: ${escapeHtml(c.text)}
                    <span class="text-xs text-gray-500 ml-2">${c.time}</span>
                  </div>
                  ${canDeleteComment ? 
                    `<button class="text-red-400 hover:text-red-300 text-xs" onclick="deleteComment(${p.id}, ${c.id})"><i class="fa fa-trash"></i></button>` : ''}
                </div>
              `}).join('') : ''}
            </div>
          </div>
        </div>
      `;
      list.innerHTML += html;
    });
    
    // 为所有评论输入框添加字数统计
    D.posts.forEach(p => {
      const input = document.getElementById(`commentInput-${p.id}`);
      const counter = document.getElementById(`commentCount-${p.id}`);
      if (input && counter) {
        input.addEventListener('input', function() {
          counter.textContent = this.value.length + '/500';
        });
      }
    });
  }

  // 载入作品
  async function loadWorks() {
    const grid = document.getElementById('portfolioGrid');
    grid.innerHTML = '';
    
    if (D.works.length === 0) {
      grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500"><p>暂无作品</p></div>';
      return;
    }
    
    D.works.forEach(w => {
      const html = `
        <div class="fade-in cyber-card">
          <div class="cyber-border rounded-lg overflow-hidden bg-black/10">
            <div class="h-48 overflow-hidden cursor-pointer" onclick="showWorkModal('${escapeHtml(w.img)}', '${escapeHtml(w.title)}', '${escapeHtml(w.cate)}')">
              <img src="${w.img}" class="w-full h-full object-cover img-scale" alt="${escapeHtml(w.title)}" loading="lazy">
            </div>
            <div class="p-4">
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg">${escapeHtml(w.title)}</h3>
                <span class="text-xs bg-primary text-dark px-2 py-1 rounded">${escapeHtml(w.cate)}</span>
              </div>
              <p class="text-gray-400 text-sm mb-3">文件大小: ${w.size || '未知'}</p>
              <div class="flex gap-2">
                <button class="flex-1 bg-primary/20 text-primary py-2 rounded hover:bg-primary/30 transition" onclick="showWorkModal('${escapeHtml(w.img)}', '${escapeHtml(w.title)}', '${escapeHtml(w.cate)}')">查看详情</button>
                <button class="px-3 bg-primary text-dark rounded hover:brightness-110 transition" onclick="downloadWork('${escapeHtml(w.title)}')"><i class="fa fa-download"></i></button>
              </div>
            </div>
          </div>
        </div>
      `;
      grid.innerHTML += html;
    });
  }

  // 载入安装包
  async function loadPackages() {
    const grid = document.getElementById('packageGrid');
    grid.innerHTML = '';
    
    if (D.packages.length === 0) {
      grid.innerHTML = '<p class="text-gray-400 text-center col-span-full py-10">暂无安装包，登录后上传第一个吧！</p>';
      return;
    }
    
    D.packages.slice().reverse().forEach(p => {
      const canDelete = D.user && (D.user.role === 'admin' || D.user.email === p.uploader);
      const html = `
        <div class="cyber-border rounded-lg p-5 bg-black/20 fade-in cyber-card">
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-bold text-xl">${escapeHtml(p.name)}</h3>
            ${canDelete ? `<button class="text-red-400 hover:text-red-300" onclick="deletePackage(${p.id})"><i class="fa fa-trash"></i></button>` : ''}
          </div>
          <p class="text-gray-400 text-sm mb-4">${escapeHtml(p.desc)}</p>
          <div class="flex justify-between items-center text-sm text-gray-500">
            <span>上传者: ${escapeHtml(p.uploaderUsername || p.uploader)}</span>
            <span>${p.time}</span>
          </div>
          <div class="mt-4 flex justify-between items-center">
            <span class="text-sm text-gray-400"><i class="fa fa-download mr-1"></i> ${p.downloads || 0} 次下载</span>
            <button onclick="downloadPackage(${p.id})" class="px-4 py-2 bg-primary text-dark rounded hover:brightness-110 transition">立即下载</button>
          </div>
        </div>
      `;
      grid.innerHTML += html;
    });
  }

  // 图片预览功能
  document.getElementById('postImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (file) {
      // 检查文件大小（限制5MB）
      if (file.size > 5 * 1024 * 1024) {
        alert('图片大小不能超过5MB');
        this.value = '';
        return;
      }
      
      // 检查文件类型
      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        alert('请选择JPG、PNG、GIF或WebP格式的图片');
        this.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      preview.classList.add('hidden');
    }
  });

  // 发送帖子
  document.getElementById('sendPost').onclick = async function() {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    const imageInput = document.getElementById('postImage');
    
    if (!title || !content) {
      alert('请填写标题和内容');
      return;
    }
    
    if (title.length > 100) {
      alert('标题不能超过100字');
      return;
    }
    
    if (content.length > 1000) {
      alert('内容不能超过1000字');
      return;
    }
    
    if (!D.user) {
      showLogin();
      alert('请先登录');
      return;
    }
    
    // 防止重复提交
    this.disabled = true;
    const originalText = this.textContent;
    this.textContent = '发布中...';
    
    // 处理图片上传
    const processImage = (callback) => {
      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        // 检查文件大小
        if (file.size > 5 * 1024 * 1024) {
          alert('图片大小不能超过5MB');
          callback(null);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          callback(e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        callback(null);
      }
    };
    
    processImage(async function(imageData) {
      const postData = {
        id: Date.now(),
        title: title,
        content: content,
        userEmail: D.user.email,
        userUsername: D.user.username,
        time: new Date().toLocaleString('zh-CN'),
        image: imageData,
        comments: []
      };
      
      D.posts.push(postData);
      const saved = await saveDataToJSONBin();
      
      // 恢复按钮状态
      document.getElementById('sendPost').disabled = false;
      document.getElementById('sendPost').textContent = originalText;
      
      if (saved) showTip('帖子发布成功！');
      
      // 清空表单
      document.getElementById('postTitle').value = '';
      document.getElementById('postContent').value = '';
      document.getElementById('postImage').value = '';
      document.getElementById('imagePreview').classList.add('hidden');
      document.getElementById('charCount').textContent = '0/1000';
      
      await loadPosts();
    });
  };

  // 字数统计
  document.getElementById('postContent').addEventListener('input', function() {
    document.getElementById('charCount').textContent = this.value.length + '/1000';
  });

  // 显示登录弹窗
  window.showLogin = function() {
    document.getElementById('loginModal').classList.remove('hidden');
  };

  // 登录
  document.getElementById('loginBtn').onclick = async function() {
    const email = document.getElementById('email').value.trim();
    const pwd = document.getElementById('pwd').value.trim();
    
    if (!email || !pwd) {
      alert('请填写邮箱和密码');
      return;
    }
    
    const user = D.users.find(u => u.email === email && u.pwd === pwd);
    if (user) {
      D.user = {
        email: user.email,
        username: user.username,
        role: user.role
      };
      localStorage.setItem('user', JSON.stringify(D.user));
      updateUI();
      document.getElementById('loginModal').classList.add('hidden');
      // 清空登录表单
      document.getElementById('username').value = '';
      document.getElementById('email').value = '';
      document.getElementById('pwd').value = '';
      showTip('登录成功！');
    } else {
      alert('邮箱或密码错误');
    }
  };

  // 注册
  document.getElementById('regBtn').onclick = async function() {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const pwd = document.getElementById('pwd').value.trim();
    
    if (!username || !email || !pwd) {
      alert('请填写用户名、邮箱和密码');
      return;
    }
    
    // 验证用户名长度
    if (username.length < 2 || username.length > 20) {
      alert('用户名长度应为2-20个字符');
      return;
    }
    
    // 验证邮箱格式
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('请输入有效的邮箱地址');
      return;
    }
    
    // 验证密码长度
    if (pwd.length < 6) {
      alert('密码长度至少6位');
      return;
    }
    
    // 检查用户名是否已存在
    if (D.users.find(u => u.username === username)) {
      alert('用户名已存在');
      return;
    }
    
    // 检查邮箱是否已存在
    if (D.users.find(u => u.email === email)) {
      alert('邮箱已存在');
      return;
    }
    
    D.users.push({
      email: email,
      username: username,
      pwd: pwd,
      role: 'user'
    });
    
    const saved = await saveDataToJSONBin();
    if (saved) {
      D.user = {
        email: email,
        username: username,
        role: 'user'
      };
      localStorage.setItem('user', JSON.stringify(D.user));
      updateUI();
      document.getElementById('loginModal').classList.add('hidden');
      // 清空注册表单
      document.getElementById('username').value = '';
      document.getElementById('email').value = '';
      document.getElementById('pwd').value = '';
      showTip('注册成功！');
    }
  };

  // 编辑帖子
  window.editPost = function(id) {
    const post = D.posts.find(p => p.id === id);
    if (!post) return;
    
    document.getElementById('editTitle').value = post.title;
    document.getElementById('editContent').value = post.content;
    
    // 显示原有图片预览
    const editPreview = document.getElementById('editImagePreview');
    editPreview.innerHTML = '';
    if (post.image) {
      editPreview.innerHTML = `
        <p class="text-gray-400 text-xs mb-1">当前图片：</p>
        <img src="${post.image}" class="max-h-40 rounded border border-gray-700 mb-2">
      `;
    }
    
    // 设置当前编辑的帖子ID
    document.getElementById('editModal').dataset.editingId = id;
    document.getElementById('editModal').classList.remove('hidden');
  };

  // 保存编辑
  document.getElementById('saveEdit').onclick = async function() {
    const id = parseInt(document.getElementById('editModal').dataset.editingId);
    const post = D.posts.find(p => p.id === id);
    if (!post) return;
    
    const newTitle = document.getElementById('editTitle').value.trim();
    const newContent = document.getElementById('editContent').value.trim();
    const imageInput = document.getElementById('editPostImage');
    
    if (!newTitle || !newContent) {
      alert('请填写标题和内容');
      return;
    }
    
    if (newTitle.length > 100) {
      alert('标题不能超过100字');
      return;
    }
    
    if (newContent.length > 1000) {
      alert('内容不能超过1000字');
      return;
    }
    
    // 处理图片更新
    const processEditImage = async (callback) => {
      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        // 检查文件大小
        if (file.size > 5 * 1024 * 1024) {
          alert('图片大小不能超过5MB');
          callback(post.image); // 保持原图
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          callback(e.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        callback(post.image); // 保持原图
      }
    };
    
    processEditImage(async function(imageData) {
      post.title = newTitle;
      post.content = newContent;
      post.image = imageData;
      post.editTime = new Date().toLocaleString('zh-CN');
      
      const saved = await saveDataToJSONBin();
      document.getElementById('editModal').classList.add('hidden');
      await loadPosts();
      if (saved) showTip('帖子已更新');
    });
  };

  // 删除帖子
  window.deletePost = async function(id) {
    if (!confirm('确定要删除这个帖子吗？')) return;
    
    D.posts = D.posts.filter(p => p.id !== id);
    const saved = await saveDataToJSONBin();
    await loadPosts();
    if (saved) showTip('帖子已删除');
  };

  // 清空发帖表单
  document.getElementById('clearPost').onclick = function() {
    document.getElementById('postTitle').value = '';
    document.getElementById('postContent').value = '';
    document.getElementById('postImage').value = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('charCount').textContent = '0/1000';
    showTip('表单已清空');
  };

  // 评论功能
  window.addComment = async function(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const text = input.value.trim();
    if (!text) return;
    
    if (text.length > 500) {
      alert('评论不能超过500字');
      return;
    }
    
    if (!D.user) {
      showLogin();
      alert('请先登录');
      return;
    }
    
    const post = D.posts.find(p => p.id === postId);
    if (!post) return;
    
    if (!post.comments) post.comments = [];
    
    post.comments.push({
      id: Date.now(),
      userEmail: D.user.email,
      userUsername: D.user.username,
      text: text,
      time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    });
    
    const saved = await saveDataToJSONBin();
    input.value = '';
    document.getElementById(`commentCount-${postId}`).textContent = '0/500';
    await loadPosts();
    if (saved) showTip('评论已发布');
  };

  window.deleteComment = async function(postId, commentId) {
    const post = D.posts.find(p => p.id === postId);
    if (post && post.comments) {
      post.comments = post.comments.filter(c => c.id !== commentId);
      const saved = await saveDataToJSONBin();
      await loadPosts();
      if (saved) showTip('评论已删除');
    }
  };

  // 上传安装包
  document.getElementById('uploadPackage').onclick = async function() {
    const name = document.getElementById('packageName').value.trim();
    const desc = document.getElementById('packageDesc').value.trim();
    const fileInput = document.getElementById('packageFile');
    
    if (!name || !desc) {
      alert('请填写安装包名称和简介');
      return;
    }
    
    if (name.length > 50) {
      alert('安装包名称不能超过50字');
      return;
    }
    
    if (desc.length > 200) {
      alert('简介不能超过200字');
      return;
    }
    
    if (!fileInput.files || fileInput.files.length === 0) {
      alert('请选择要上传的文件');
      return;
    }
    
    const file = fileInput.files[0];
    if (file.size > 10 * 1024 * 1024) {
      alert('文件大小不能超过10MB');
      return;
    }
    
    if (!D.user) {
      showLogin();
      alert('请先登录');
      return;
    }
    
    // 防止重复提交
    this.disabled = true;
    const originalText = this.textContent;
    this.textContent = '上传中...';
    
    const reader = new FileReader();
    
    reader.onload = async function(e) {
      const fileData = {
        id: Date.now(),
        name: name,
        desc: desc,
        uploader: D.user.email,
        uploaderUsername: D.user.username,
        time: new Date().toLocaleDateString('zh-CN'),
        file: e.target.result,
        fileName: file.name,
        downloads: 0
      };
      
      D.packages.push(fileData);
      const saved = await saveDataToJSONBin();
      
      // 恢复按钮状态
      document.getElementById('uploadPackage').disabled = false;
      document.getElementById('uploadPackage').textContent = originalText;
      
      if (saved) {
        document.getElementById('packageName').value = '';
        document.getElementById('packageDesc').value = '';
        fileInput.value = '';
        
        await loadPackages();
        showTip('安装包上传成功！');
      }
    };
    
    reader.readAsDataURL(file);
  };

  // 下载安装包
  window.downloadPackage = async function(id) {
    const pkg = D.packages.find(p => p.id === id);
    if (!pkg) return;
    
    // 增加下载计数
    pkg.downloads = (pkg.downloads || 0) + 1;
    await saveDataToJSONBin();
    
    // 创建下载链接
    if (pkg.file && pkg.file !== '#') {
      const link = document.createElement('a');
      link.href = pkg.file;
      link.download = pkg.fileName || `${pkg.name}.download`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showTip(`开始下载: ${pkg.name}`);
    } else {
      showTip('该文件暂不可下载');
    }
    
    await loadPackages();
  };

  // 删除安装包
  window.deletePackage = async function(id) {
    if (!confirm('确定要删除这个安装包吗？')) return;
    
    D.packages = D.packages.filter(p => p.id !== id);
    const saved = await saveDataToJSONBin();
    await loadPackages();
    if (saved) showTip('安装包已删除');
  };

  // 轮播功能
  let carouselIndex = 0;
  const items = document.querySelectorAll('.carousel-item');
  const dots = document.querySelectorAll('.carousel-dot');
  let carouselInterval;
  
  function showCarouselItem(index) {
    items.forEach(item => item.classList.remove('active'));
    dots.forEach(dot => dot.classList.replace('bg-primary', 'bg-primary/30'));
    
    items[index].classList.add('active');
    dots[index].classList.replace('bg-primary/30', 'bg-primary');
  }
  
  function startCarousel() {
    carouselInterval = setInterval(() => {
      carouselIndex = (carouselIndex + 1) % items.length;
      showCarouselItem(carouselIndex);
    }, 5000);
  }
  
  function stopCarousel() {
    clearInterval(carouselInterval);
  }
  
  startCarousel();
  
  // 鼠标悬停时暂停轮播
  const carouselSection = document.querySelector('#home .carousel');
  if (carouselSection) {
    carouselSection.addEventListener('mouseenter', stopCarousel);
    carouselSection.addEventListener('mouseleave', startCarousel);
  }
  
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      carouselIndex = index;
      showCarouselItem(index);
      stopCarousel();
      startCarousel();
    });
  });

  // 主题切换
  document.getElementById('themeBtn').onclick = function() {
    toggleTheme();
  };
  document.getElementById('mobileTheme').onclick = function() {
    toggleTheme();
  };
  
  function toggleTheme() {
    if (D.theme === 'dark') {
      D.theme = 'light';
      document.documentElement.classList.remove('dark');
      document.getElementById('themeBtn').textContent = '暗色';
      document.getElementById('mobileTheme').textContent = '暗色';
    } else {
      D.theme = 'dark';
      document.documentElement.classList.add('dark');
      document.getElementById('themeBtn').textContent = '亮色';
      document.getElementById('mobileTheme').textContent = '亮色';
    }
    localStorage.setItem('theme', D.theme);
  }

  // 移动菜单
  document.getElementById('menuBtn').onclick = function() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('hidden');
  };
  
  // 移动端菜单点击后关闭
  document.querySelectorAll('#mobileMenu a').forEach(link => {
    link.addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.add('hidden');
    });
  });

  // 显示提示
  function showTip(msg) {
    const tip = document.getElementById('tip');
    tip.textContent = msg;
    tip.classList.remove('hidden');
    setTimeout(() => tip.classList.add('hidden'), 2000);
  }

  // 关闭弹窗
  document.getElementById('closeLogin').onclick = function() {
    document.getElementById('loginModal').classList.add('hidden');
  };
  document.getElementById('closeWorkModal').onclick = function() {
    document.getElementById('workModal').classList.add('hidden');
  };
  document.getElementById('closeWorkBtn').onclick = function() {
    document.getElementById('workModal').classList.add('hidden');
  };
  document.getElementById('closeWorkIcon').onclick = function() {
    document.getElementById('workModal').classList.add('hidden');
  };
  document.getElementById('closeEdit').onclick = function() {
    document.getElementById('editModal').classList.add('hidden');
  };
  document.getElementById('cancelEdit').onclick = function() {
    document.getElementById('editModal').classList.add('hidden');
  };

  // 作品筛选
  document.getElementById('searchWork').addEventListener('input', function() {
    const search = this.value.toLowerCase();
    document.querySelectorAll('#portfolioGrid .cyber-card').forEach(card => {
      const title = card.querySelector('h3').textContent.toLowerCase();
      card.style.display = title.includes(search) ? '' : 'none';
    });
  });

  document.querySelectorAll('.cate-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const cate = this.dataset.cate;
      document.querySelectorAll('.cate-btn').forEach(b => 
        b.classList.replace('bg-primary', 'bg-gray-800')
      );
      this.classList.replace('bg-gray-800', 'bg-primary');
      
      const search = document.getElementById('searchWork').value.toLowerCase();
      
      document.querySelectorAll('#portfolioGrid .cyber-card').forEach(card => {
        const cardTitle = card.querySelector('h3').textContent.toLowerCase();
        const cardCate = card.querySelector('span').textContent;
        const matchesSearch = search === '' || cardTitle.includes(search);
        const matchesCate = cate === 'all' || cardCate === cate;
        
        card.style.display = (matchesSearch && matchesCate) ? '' : 'none';
      });
    });
  });

  // 作品预览
  window.showWorkModal = function(img, title, cate) {
    document.getElementById('workModalImg').src = img;
    document.getElementById('workModalTitle').textContent = title;
    document.getElementById('workModalCate').textContent = cate;
    document.getElementById('workModal').classList.remove('hidden');
  };

  window.downloadWork = function(title) {
    showTip('开始下载: ' + title);
  };

  document.getElementById('downloadSingle').onclick = function() {
    const title = document.getElementById('workModalTitle').textContent;
    downloadWork(title);
  };

  // 管理员功能
  document.getElementById('adminBtn').onclick = function() {
    const panel = document.getElementById('adminPanel');
    panel.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
      loadAdminData();
    }
  };
  document.getElementById('mobileAdmin').onclick = function() {
    const panel = document.getElementById('adminPanel');
    panel.classList.toggle('hidden');
    if (!panel.classList.contains('hidden')) {
      loadAdminData();
    }
  };

  async function loadAdminData() {
    // 加载作品管理列表
    const workList = document.getElementById('adminWorkList');
    workList.innerHTML = D.works.map(w => `
      <div class="p-2 border-b border-gray-700 flex justify-between">
        <span>${escapeHtml(w.title)}</span>
        <button class="text-red-400 hover:text-red-300 text-sm" onclick="adminDeleteWork(${w.id})">删除</button>
      </div>
    `).join('');
    
    // 加载用户管理列表
    const userList = document.getElementById('adminUserList');
    userList.innerHTML = D.users.map(u => `
      <div class="p-2 border-b border-gray-700 flex justify-between">
        <span>${escapeHtml(u.username || u.email)} (${u.role})</span>
        ${u.role !== 'admin' ? `<button class="text-red-400 hover:text-red-300 text-sm" onclick="adminDeleteUser('${u.email}')">删除</button>` : '<span class="text-gray-500 text-sm">管理员</span>'}
      </div>
    `).join('');
    
    // 加载安装包管理列表
    const packageList = document.getElementById('adminPackageList');
    packageList.innerHTML = D.packages.map(p => `
      <div class="p-2 border-b border-gray-700 flex justify-between">
        <span>${escapeHtml(p.name)}</span>
        <button class="text-red-400 hover:text-red-300 text-sm" onclick="deletePackage(${p.id})">删除</button>
      </div>
    `).join('');
  }

  // 管理员删除作品
  window.adminDeleteWork = async function(id) {
    if (!confirm('确定要删除这个作品吗？')) return;
    D.works = D.works.filter(w => w.id !== id);
    const saved = await saveDataToJSONBin();
    await loadWorks();
    loadAdminData();
    if (saved) showTip('作品已删除');
  };

  // 管理员删除用户（同时清理相关数据）
  window.adminDeleteUser = async function(email) {
    if (!confirm('确定要删除这个用户吗？同时会
